#!/bin/bash

# Production Access Debug Script
# Helps diagnose why sidebar production link redirects to dashboard

echo "üîç Production Access Debug Helper"
echo "=================================="
echo ""

echo "üìã Step-by-Step Debugging Guide:"
echo ""

echo "1Ô∏è‚É£  Clear Browser Cache & Cookies"
echo "   - Open browser DevTools (F12)"
echo "   - Right-click on Refresh button ‚Üí Empty Cache and Hard Reload"
echo "   - Or go to Application tab ‚Üí Clear all storage"
echo "   - Reason: Old auth session might be cached"
echo ""

echo "2Ô∏è‚É£  Check Current Login Session"
echo "   - Open browser console (F12)"
echo "   - Run this command:"
echo "   > fetch('/api/auth/session').then(r => r.json()).then(console.log)"
echo ""
echo "   Expected output:"
echo "   {"
echo "     user: {"
echo "       email: 'your-email@sppg-purwakarta.com',"
echo "       userRole: 'SPPG_PRODUKSI_MANAGER', // or one of 6 allowed roles"
echo "       sppgId: 'clxxx...' // Should NOT be null"
echo "     }"
echo "   }"
echo ""

echo "3Ô∏è‚É£  Check canAccess Function in Browser"
echo "   - Open browser console"
echo "   - Check if sidebar is hiding the link:"
echo "   - Inspect Production link in sidebar"
echo "   - If link is missing/hidden ‚Üí canAccess returned false"
echo ""

echo "4Ô∏è‚É£  Verify Login Credentials"
echo "   - Logout completely from app"
echo "   - Login with one of these accounts:"
echo ""
echo "   ‚úÖ RECOMMENDED:"
echo "   Email: produksi@sppg-purwakarta.com"
echo "   Password: password123"
echo "   Role: SPPG_PRODUKSI_MANAGER"
echo ""
echo "   ‚úÖ ALTERNATIVE:"
echo "   Email: admin@sppg-purwakarta.com"
echo "   Password: password123"
echo "   Role: SPPG_ADMIN"
echo ""

echo "5Ô∏è‚É£  Check Middleware Logs (Server Side)"
echo "   - Check terminal running 'npm run dev'"
echo "   - Look for any redirect logs when accessing /production"
echo "   - Middleware should NOT redirect if role is correct"
echo ""

echo "6Ô∏è‚É£  Direct URL Test"
echo "   - Try navigating directly to: http://localhost:3000/production"
echo "   - If this works but sidebar doesn't ‚Üí client-side issue"
echo "   - If this also redirects ‚Üí server-side middleware issue"
echo ""

echo "7Ô∏è‚É£  Database Verification"
echo "   - Open Prisma Studio: npx prisma studio"
echo "   - Go to User table"
echo "   - Find your user by email"
echo "   - Verify:"
echo "     ‚úÖ userRole is one of: SPPG_KEPALA, SPPG_ADMIN, SPPG_PRODUKSI_MANAGER,"
echo "        SPPG_STAFF_DAPUR, SPPG_STAFF_QC, SPPG_AHLI_GIZI"
echo "     ‚úÖ sppgId is NOT NULL"
echo "     ‚úÖ isActive is true"
echo ""

echo "üêõ Common Issues & Solutions:"
echo ""
echo "Issue 1: Link not visible in sidebar"
echo "  Cause: canAccess('production') returning false"
echo "  Solution: Check user role matches one of 6 allowed roles"
echo ""
echo "Issue 2: Link visible but redirects"
echo "  Cause: Middleware blocking access"
echo "  Solution: Check middleware.ts allows your role"
echo ""
echo "Issue 3: Session shows wrong role"
echo "  Cause: Old cached session"
echo "  Solution: Logout ‚Üí Clear cache ‚Üí Login again"
echo ""
echo "Issue 4: sppgId is null"
echo "  Cause: User not associated with SPPG"
echo "  Solution: Check database, assign user to SPPG"
echo ""

echo "üìÅ Files to Check:"
echo ""
echo "1. src/hooks/use-auth.ts (line 212)"
echo "   case 'production':"
echo "     return hasRole(['SPPG_KEPALA', 'SPPG_ADMIN', 'SPPG_PRODUKSI_MANAGER',"
echo "                     'SPPG_STAFF_DAPUR', 'SPPG_STAFF_QC', 'SPPG_AHLI_GIZI'])"
echo ""
echo "2. src/middleware.ts (line 147-150)"
echo "   if (pathname.startsWith('/production') &&"
echo "       !['SPPG_KEPALA', 'SPPG_ADMIN', 'SPPG_PRODUKSI_MANAGER',"
echo "         'SPPG_STAFF_DAPUR', 'SPPG_STAFF_QC', 'SPPG_AHLI_GIZI'].includes(userRole))"
echo ""

echo "üß™ Quick Test Command:"
echo ""
echo "# Check if server is running and restart if needed"
echo "pkill -f 'next dev' && npm run dev"
echo ""

echo "üí° Still Having Issues?"
echo ""
echo "Try this complete reset:"
echo "1. Stop dev server (Ctrl+C)"
echo "2. rm -rf .next"
echo "3. npm run dev"
echo "4. Clear browser cache completely"
echo "5. Login with fresh credentials"
echo "6. Navigate to /production"
echo ""

echo "‚úÖ If all else fails, provide these details:"
echo "   - Current user email"
echo "   - User role from database"
echo "   - Session output from browser console"
echo "   - Terminal logs when accessing /production"
echo "   - Screenshot of sidebar (is production link visible?)"
echo ""
